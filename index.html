<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Starlark</title>
  <link rel="stylesheet" href="style.css">

  <script type="text/javascript" src="third_party/codeflask.min.js"></script>
  <script type="text/javascript" src="third_party/prism-python.js"></script>
  <script type="text/javascript" src="wasm_exec.js"></script>
  <script type="text/javascript">
    async function run(fileUrl) {
      try {
        const go = new Go();
        const file = await fetch(fileUrl, { cache: "no-cache" });
        const buffer = await file.arrayBuffer();
        const { instance } = await WebAssembly.instantiate(buffer, go.importObject);
        go.run(instance);
        init();
      } catch (err) {
        console.error(err);
      }
    }
    setTimeout(() => run("/build/starlark-go.wasm"));
  </script>

</head>

<body>

  <h1>Starlark Playground</h1>

  <div id="code-container" class="editor-output-container">
    <div class="editor-container">
      <label for="editor">Code Editor</label>
      <div id="code-window" class="code-window">
        <div id="code-editor" class="code-editor"></div>
      </div>

    </div>

    <div class="resizer" id="resizer"></div>

    <div class="output-container">
      <label for="output">Output</label>
      <code id="output" class="output"></pre>
      </div>
    </div>
    
<script>
  const flask = new CodeFlask('.code-editor', {
    language: 'py',
    lineNumbers: true
  });

  flask.addLanguage('py', Prism.languages.python)


  var error = document.getElementById("error");
  var output = document.getElementById("output");
  var wrapper = document.getElementById("wrapper");

  // Called from main.go
  function setError(msg) {
    output.textContent = msg;
  }

  // Called from main.go
  function updateOutput(msg) {
    output.textContent += msg + "\n";
  }

  function init() {
    flask.updateCode(`name = "world"
print("Hello {}!".format(name))
`);

    flask.onUpdate((code) => {
      // Triggered whenever the code is updated.
      // error.textContent = "";
      output.textContent = "";
      evalStarlark(flask.getCode()); // wasm function (in main.go)
    });
  }


  const resizer = document.getElementById('resizer');
  const editorCont = document.querySelector('.editor-container');
  const outputCont = document.querySelector('.output-container');
  let isResizing = false;

  // Listen for mouse down on the resizer
  resizer.addEventListener('mousedown', (e) => {
    isResizing = true;
    document.body.style.cursor = 'ew-resize';
  });

  // Listen for mouse movement
  document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    const container = resizer.parentElement;
    const offsetLeft = e.clientX - container.offsetLeft;
    const containerWidth = container.offsetWidth;
    const percentage = (offsetLeft / containerWidth) * 100;

    editorCont.style.flex = `${percentage} 0 0`;
    outputCont.style.flex = `${100 - percentage} 0 0`;
  });

  // Listen for mouse up
  document.addEventListener('mouseup', () => {
    if (isResizing) {
      isResizing = false;
      document.body.style.cursor = 'default';
    }
  });


</script>
